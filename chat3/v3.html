<!doctype html>
<html lang="vi" class="dark">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>One Chat — Public Room</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      :root{--accent:#10b981;--bubble-bg:#0b1220;--bubble-border:#26303a}
      .msg-bubble { background-color: var(--bubble-bg); border-color: var(--bubble-border); }
      /* small helper to visually hide while keeping layout */
      .sr-only{position:absolute!important;height:1px;width:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    </style>
    <script>
      // Tailwind dark mode class strategy
      tailwind.config = { darkMode: 'class' }
    </script>
  </head>
  <body class="bg-neutral-950 text-neutral-100 dark:bg-neutral-950 dark:text-neutral-100">
    <!-- Top Nav -->
    <header class="sticky top-0 z-20 bg-neutral-900/90 backdrop-blur border-b border-neutral-800">
      <div class="mx-auto max-w-3xl px-3 h-12 flex items-center justify-between">
        <!-- Left: app name -->
        <div id="appName" class="font-semibold tracking-wide">One Chat</div>
        <!-- Right: menu button -->
        <button id="menuBtn" aria-expanded="false" class="p-2 rounded-lg hover:bg-neutral-800">
          ☰
        </button>
      </div>

      <!-- Dropdown Menu -->
      <div id="menuPanel" class="hidden absolute right-3 top-14 w-72 bg-neutral-900 border border-neutral-800 rounded-xl shadow-lg p-2">
        <!-- Tabs horizontal scroll -->
        <div class="overflow-x-auto">
          <div id="tabs" class="flex gap-2 px-2">
            <button data-tab="basic" class="tab-btn px-3 py-1 rounded-xl text-sm whitespace-nowrap">Cơ bản</button>
            <button data-tab="notify" class="tab-btn px-3 py-1 rounded-xl text-sm whitespace-nowrap">Thông báo</button>
            <button data-tab="custom" class="tab-btn px-3 py-1 rounded-xl text-sm whitespace-nowrap">Tùy chỉnh</button>
          </div>
        </div>

        <div id="tabPanels" class="mt-3">
          <!-- Basic Tab -->
          <div data-panel="basic" class="tab-panel">
            <div class="flex items-center gap-2 text-sm select-none mb-2">
              <span id="connDot" class="inline-block h-2.5 w-2.5 rounded-full bg-neutral-500"></span>
              <span id="connText" class="text-neutral-400">Đang khởi động…</span>
            </div>
            <div class="flex items-center gap-2 mb-3">
              <img id="userAvatar" class="hidden h-8 w-8 rounded-full border border-neutral-700" />
              <div>
                <div id="userName" class="text-sm text-neutral-300"> </div>
                <div class="text-xs text-neutral-500">Tài khoản Google</div>
              </div>
            </div>
            <button id="loginBtn" class="w-full text-sm px-3 py-2 rounded-xl bg-neutral-100 text-neutral-900 font-medium">Đăng nhập</button>
          </div>

          <!-- Notifications Tab (placeholder) -->
          <div data-panel="notify" class="tab-panel hidden">
            <div class="text-sm text-neutral-400">(Tạm thời) Cấu hình thông báo sẽ được bổ sung sau.</div>
          </div>

          <!-- Custom Tab -->
          <div data-panel="custom" class="tab-panel hidden">
            <div class="space-y-3">
              <div>
                <div class="text-xs text-neutral-400 mb-1">Chế độ màu</div>
                <div class="flex gap-2">
                  <button id="themeLight" class="px-3 py-1 rounded-lg bg-neutral-100 text-neutral-900 text-sm">Sáng</button>
                  <button id="themeDark" class="px-3 py-1 rounded-lg bg-neutral-800 text-neutral-200 text-sm">Tối</button>
                </div>
              </div>

              <div>
                <div class="text-xs text-neutral-400 mb-1">Kích thước chữ</div>
                <div class="flex gap-2">
                  <button data-size="small" class="size-btn px-3 py-1 rounded-lg bg-neutral-800 text-neutral-200 text-sm">Nhỏ</button>
                  <button data-size="normal" class="size-btn px-3 py-1 rounded-lg bg-neutral-800 text-neutral-200 text-sm">Vừa</button>
                  <button data-size="large" class="size-btn px-3 py-1 rounded-lg bg-neutral-800 text-neutral-200 text-sm">Lớn</button>
                </div>
              </div>

              <div>
                <div class="text-xs text-neutral-400 mb-1">Góc bo bong bóng</div>
                <div class="flex gap-2">
                  <button data-bubble="rounded" class="bubble-btn px-3 py-1 rounded-lg bg-neutral-800 text-neutral-200 text-sm">Bo tròn</button>
                  <button data-bubble="pill" class="bubble-btn px-3 py-1 rounded-lg bg-neutral-800 text-neutral-200 text-sm">Pill</button>
                  <button data-bubble="flat" class="bubble-btn px-3 py-1 rounded-lg bg-neutral-800 text-neutral-200 text-sm">Phẳng</button>
                </div>
              </div>

              <div>
                <div class="text-xs text-neutral-400 mb-1">Màu chủ đạo</div>
                <div class="flex gap-2 items-center">
                  <button data-color="#10b981" class="color-btn w-8 h-8 rounded-full" style="background:#10b981"></button>
                  <button data-color="#3b82f6" class="color-btn w-8 h-8 rounded-full" style="background:#3b82f6"></button>
                  <button data-color="#8b5cf6" class="color-btn w-8 h-8 rounded-full" style="background:#8b5cf6"></button>
                  <button data-color="#ef4444" class="color-btn w-8 h-8 rounded-full" style="background:#ef4444"></button>
                  <button data-color="#f59e0b" class="color-btn w-8 h-8 rounded-full" style="background:#f59e0b"></button>
                </div>
              </div>

              <div>
                <button id="resetCustom" class="w-full px-3 py-2 rounded-lg bg-neutral-800 text-neutral-200 text-sm">Khôi phục mặc định</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Messages -->
    <main class="mx-auto max-w-3xl px-3">
      <div id="messages" class="mt-3 mb-24 space-y-2 overflow-y-auto max-h-[calc(100dvh-10rem)] pr-1">
        <!-- messages will render here -->
      </div>
    </main>

    <!-- Composer -->
    <footer class="fixed bottom-0 left-0 right-0 bg-neutral-900/80 backdrop-blur border-t border-neutral-800">
      <form id="composer" class="mx-auto max-w-3xl px-3 py-3 grid grid-cols-12 gap-2">
        <input id="text" type="text" placeholder="Nhập tin nhắn…"
               class="col-span-10 md:col-span-11 rounded-2xl bg-neutral-800 border border-neutral-700 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-neutral-500"
               maxlength="500" required />
        <button id="sendBtn" type="submit"
                class="col-span-2 md:col-span-1 rounded-2xl bg-neutral-100 text-neutral-900 font-medium px-3 py-2 disabled:opacity-50 disabled:cursor-not-allowed">
          Gửi
        </button>
      </form>
    </footer>

    <!-- Firebase + App Script -->
    <script type="module">
      // --- Firebase SDKs (v11, modular) ---
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js'
      import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, limit, onSnapshot } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js'
      import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js'

      // 1) Paste your config from Firebase Console here
      const firebaseConfig = {
  apiKey: "AIzaSyD-TXkpROaUzr0rmf6DvchEfMTgfRCmHdU",
  authDomain: "relifechat.firebaseapp.com",
  projectId: "relifechat",
  storageBucket: "relifechat.firebasestorage.app",
  messagingSenderId: "108424998260",
  appId: "1:108424998260:web:d1472805ee5a1c3c94d021",
  measurementId: "G-N6VWB9GRV3"
};

      // 2) Init Firebase
      const app = initializeApp(firebaseConfig)
      const db = getFirestore(app)
      const auth = getAuth(app)
      const provider = new GoogleAuthProvider()

      // --- DOM ---
      const $ = (s) => document.querySelector(s)
      const messagesEl = $('#messages')
      const form = $('#composer')
      const textInput = $('#text')
      const sendBtn = $('#sendBtn')
      const connDot = $('#connDot')
      const connText = $('#connText')
      const loginBtn = $('#loginBtn')
      const userAvatar = $('#userAvatar')
      const userName = $('#userName')
      const menuBtn = $('#menuBtn')
      const menuPanel = $('#menuPanel')
      const tabs = document
      const themeToggle = $('#themeToggle')

      // Customization state (persisted)
      const prefs = {
        theme: localStorage.getItem('onechat:theme') || 'dark',
        size: localStorage.getItem('onechat:size') || 'normal',
        bubble: localStorage.getItem('onechat:bubble') || 'rounded',
        accent: localStorage.getItem('onechat:accent') || getComputedStyle(document.documentElement).getPropertyValue('--accent') || '#10b981'
      }

      // Apply initial custom prefs
      const applyPrefs = () => {
        // theme
        if (prefs.theme === 'light') document.documentElement.classList.remove('dark')
        else document.documentElement.classList.add('dark')
        // size
        document.documentElement.classList.remove('text-sm','text-base','text-lg')
        if (prefs.size === 'small') document.documentElement.classList.add('text-sm')
        else if (prefs.size === 'normal') document.documentElement.classList.add('text-base')
        else if (prefs.size === 'large') document.documentElement.classList.add('text-lg')
        // bubble radius
        // store bubble as a global used in render
        window.ONECHAT_BUBBLE = prefs.bubble
        // accent
        document.documentElement.style.setProperty('--accent', prefs.accent)
        // bubble colors (tweak based on theme)
        if (prefs.theme === 'light') {
          document.documentElement.style.setProperty('--bubble-bg','#f8fafc')
          document.documentElement.style.setProperty('--bubble-border','#e6edf3')
        } else {
          document.documentElement.style.setProperty('--bubble-bg','#0b1220')
          document.documentElement.style.setProperty('--bubble-border','#26303a')
        }
        // update UI labels in menu
        if (prefs.theme === 'light') {
          $('#themeLight').classList.add('ring-2','ring-offset-1')
          $('#themeDark').classList.remove('ring-2','ring-offset-1')
        } else {
          $('#themeDark').classList.add('ring-2','ring-offset-1')
          $('#themeLight').classList.remove('ring-2','ring-offset-1')
        }
      }
      applyPrefs()

      // Helpers
      const setStatus = (state, label) => {
        const colors = { idle: 'bg-neutral-500', offline: 'bg-red-500', connecting: 'bg-amber-400', live: 'bg-emerald-500', error: 'bg-red-600' }
        connDot.className = `inline-block h-2.5 w-2.5 rounded-full ${colors[state]||colors.idle}`
        connText.textContent = label
      }

      const updateOnline = () => { if (!navigator.onLine) setStatus('offline','Ngoại tuyến (thiết bị)'); else setStatus('connecting','Đang kết nối…') }
      window.addEventListener('online', updateOnline); window.addEventListener('offline', updateOnline); updateOnline()

      const esc = (s='') => s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]))

      // Render message with customization
      function renderMsg(doc) {
        const d = doc.data()
        const name = esc(d.name || 'Ẩn danh')
        const text = esc(d.text || '')
        const t = d.createdAt?.toDate?.() || new Date()
        const time = new Intl.DateTimeFormat('vi-VN', { hour:'2-digit', minute:'2-digit' }).format(t)
        const avatar = d.photo || ''

        const item = document.createElement('div')
        // bubble rounding
        const bubbleStyle = (window.ONECHAT_BUBBLE === 'pill') ? 'rounded-full' : (window.ONECHAT_BUBBLE === 'flat') ? 'rounded-none' : 'rounded-2xl'
        item.className = `flex items-start gap-3 msg-bubble border p-3 ${bubbleStyle}`
        // apply accent as border highlight for the avatar
        const accent = getComputedStyle(document.documentElement).getPropertyValue('--accent') || '#10b981'
        item.innerHTML = `\n          <img src="${esc(avatar)}" class="h-8 w-8 rounded-full bg-neutral-800 shrink-0" onerror="this.style.display='none'" style="border:2px solid ${accent};"/>\n          <div class="min-w-0">\n            <div class="flex items-center gap-2 text-xs text-neutral-400">\n              <span class="font-medium text-neutral-200">${name}</span>\n              <span>•</span>\n              <time>${time}</time>\n            </div>\n            <div class="mt-1 text-sm leading-relaxed break-words">${text}</div>\n          </div>`
        messagesEl.appendChild(item)
      }

      const scrollToBottom = () => messagesEl.scrollTo({ top: messagesEl.scrollHeight, behavior: 'smooth' })

      // Firestore query
      const msgsRef = collection(db, 'messages')
      const q = query(msgsRef, orderBy('createdAt','asc'), limit(200))

      let initialLoaded = false
      onSnapshot(q,(snapshot)=>{
        if(!initialLoaded) messagesEl.innerHTML = ''
        snapshot.docChanges().forEach((change)=>{ if(change.type==='added') renderMsg(change.doc) })
        if(!initialLoaded){ initialLoaded=true; setStatus('live','Trực tuyến'); scrollToBottom() } else scrollToBottom()
      },(err)=>{ console.error(err); setStatus('error','Lỗi kết nối dữ liệu') })

      // Submit
      form.addEventListener('submit', async (e)=>{
        e.preventDefault()
        if(!auth.currentUser){ alert('Bạn phải đăng nhập trước khi gửi tin.'); return }
        const user = auth.currentUser
        const text = textInput.value.trim(); if(!text) return
        sendBtn.disabled = true
        try{
          await addDoc(msgsRef,{ uid:user.uid, name:user.displayName||'Ẩn danh', photo:user.photoURL||null, text, createdAt:serverTimestamp() })
          textInput.value=''; textInput.focus()
        }catch(e){ alert('Gửi thất bại. Kiểm tra kết nối rồi thử lại.'); console.error(e) }finally{ sendBtn.disabled=false }
      })
      textInput.addEventListener('keydown',(e)=>{ if(e.key==='Enter' && !e.shiftKey) form.requestSubmit() })

      // Auth state handling
      onAuthStateChanged(auth,(user)=>{
        if(user){ loginBtn.textContent='Đăng xuất'; userAvatar.src=user.photoURL; userAvatar.classList.remove('hidden'); userName.textContent = user.displayName||'' }
        else{ loginBtn.textContent='Đăng nhập'; userAvatar.classList.add('hidden'); userName.textContent = '' }
      })
      loginBtn.addEventListener('click',async ()=>{ if(auth.currentUser) await signOut(auth); else{ try{ await signInWithPopup(auth,provider) }catch(e){ console.error(e); alert('Không đăng nhập được, thử lại.') } } })

      // Menu toggle
      menuBtn.addEventListener('click',()=>{ const open = menuPanel.classList.toggle('hidden'); menuBtn.setAttribute('aria-expanded', String(open)) })

      // Tabs behavior
      const tabBtns = Array.from(document.querySelectorAll('.tab-btn'))
      const panels = Array.from(document.querySelectorAll('.tab-panel'))
      const setActiveTab = (id)=>{
        tabBtns.forEach(b=>b.classList.toggle('bg-neutral-700', b.dataset.tab===id))
        panels.forEach(p=>p.classList.toggle('hidden', p.dataset.panel!==id))
      }
      tabBtns.forEach(b=>b.addEventListener('click',()=>setActiveTab(b.dataset.tab)))
      setActiveTab('basic')

      // Custom controls wiring
      document.querySelectorAll('.size-btn').forEach(btn=>btn.addEventListener('click',()=>{ prefs.size=btn.dataset.size; localStorage.setItem('onechat:size',prefs.size); applyPrefs() }))
      document.querySelectorAll('.bubble-btn').forEach(btn=>btn.addEventListener('click',()=>{ prefs.bubble=btn.dataset.bubble; localStorage.setItem('onechat:bubble',prefs.bubble); applyPrefs() }))
      document.querySelectorAll('.color-btn').forEach(btn=>btn.addEventListener('click',()=>{ prefs.accent=btn.dataset.color; localStorage.setItem('onechat:accent',prefs.accent); applyPrefs() }))
      $('#themeLight').addEventListener('click',()=>{ prefs.theme='light'; localStorage.setItem('onechat:theme','light'); applyPrefs() })
      $('#themeDark').addEventListener('click',()=>{ prefs.theme='dark'; localStorage.setItem('onechat:theme','dark'); applyPrefs() })
      $('#resetCustom').addEventListener('click',()=>{ localStorage.removeItem('onechat:theme'); localStorage.removeItem('onechat:size'); localStorage.removeItem('onechat:bubble'); localStorage.removeItem('onechat:accent'); prefs.theme='dark'; prefs.size='normal'; prefs.bubble='rounded'; prefs.accent='#10b981'; applyPrefs(); alert('Đã khôi phục mặc định') })

      // expose small API for debug
      window.OneChatPrefs = prefs
    </script>
  </body>
</html>
