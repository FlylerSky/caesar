<!DOCTYPE html>
<html lang="en" class="light" id="html-root">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>One Chat</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase CDN (App + Database + Auth) -->
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
    <style>
        /* Custom styles for chat container and theme */
        #chat-container {
            height: calc(100vh - 10rem);
            overflow-y: auto;
            scroll-behavior: smooth;
        }
        .light {
            --bg-color: #f3f4f6;
            --text-color: #1f2937;
            --nav-bg: #2563eb;
            --message-bg: #ffffff;
            --input-bg: #ffffff;
            --border-color: #d1d5db;
            --menu-bg: #1e3a8a;
        }
        .dark {
            --bg-color: #1f2937;
            --text-color: #e5e7eb;
            --nav-bg: #1e40af;
            --message-bg: #374151;
            --input-bg: #374151;
            --border-color: #4b5563;
            --menu-bg: #111827;
        }
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        nav {
            background-color: var(--nav-bg);
        }
        .message {
            word-break: break-word;
            background-color: var(--message-bg);
        }
        .message-text {
            font-size: var(--message-font-size, 1rem);
        }
        #input-area {
            background-color: var(--input-bg);
            border-color: var(--border-color);
        }
        /* Menu styles */
        #menu {
            transition: transform 0.3s ease-in-out;
            background-color: var(--menu-bg);
        }
        #menu.hidden {
            transform: translateX(100%);
        }
        .tab {
            flex: 1;
            text-align: center;
            padding: 0.75rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
        }
        .tab.active {
            border-bottom-color: #3b82f6;
            font-weight: bold;
            color: #3b82f6;
        }
        .tab:not(.active) {
            color: #9ca3af;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: var(--message-bg);
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 8px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        /* Responsive adjustments */
        @media (max-width: 640px) {
            #chat-container {
                height: calc(100vh - 12rem);
            }
            nav {
                padding: 0.5rem 1rem;
            }
            #messages {
                padding: 0.5rem;
            }
            .message {
                padding: 0.75rem;
            }
            #input-area {
                padding: 0.5rem;
            }
            #message-input {
                font-size: 0.9rem;
            }
            #send-button {
                padding: 0.5rem 1rem;
                font-size: 0.9rem;
            }
            #menu {
                position: fixed;
                top: 0;
                right: 0;
                width: 75%;
                max-width: 16rem;
                height: 100%;
                z-index: 50;
                box-shadow: -2px 0 8px rgba(0, 0, 0, 0.3);
            }
            .tab {
                font-size: 0.9rem;
            }
            .settings-item label {
                font-size: 0.8rem;
            }
            .settings-item input, .settings-item select {
                font-size: 0.8rem;
                padding: 0.25rem;
            }
            .modal-content {
                width: 95%;
                margin: 20% auto;
            }
        }
        @media (min-width: 640px) {
            #menu-button {
                display: none;
            }
            #menu {
                position: static;
                transform: none !important;
                width: auto;
                height: auto;
                background: none;
                box-shadow: none;
            }
            #tabs {
                display: none;
            }
            .tab-content {
                display: flex !important;
                flex-direction: row;
                align-items: center;
                gap: 1rem;
            }
            .settings-item {
                margin-left: 1rem;
            }
        }
    </style>
</head>
<body class="flex flex-col min-h-screen transition-colors duration-300">
    <!-- Navigation Bar -->
    <nav class="text-white p-4 flex items-center justify-between gap-2">
        <h1 class="text-xl sm:text-2xl font-bold">One Chat</h1>
        <button id="menu-button" class="sm:hidden p-2 text-white hover:bg-blue-700 rounded-lg">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
            </svg>
        </button>
        <div id="menu" class="hidden sm:flex sm:items-center sm:space-x-4 bg-blue-800 sm:bg-transparent p-4 sm:p-0 fixed top-0 right-0 h-full flex-col">
            <div id="tabs" class="flex border-b border-gray-600 sm:hidden">
                <div id="tab-status" class="tab active">Status</div>
                <div id="tab-settings" class="tab">Settings</div>
            </div>
            <div id="status-content" class="tab-content active p-4 sm:p-0 flex flex-col sm:flex-row sm:items-center space-y-4 sm:space-y-0 sm:space-x-4">
                <div id="user-status" class="text-xs sm:text-sm hidden">Signed in as: <span id="user-name"></span></div>
                <div id="connection-status" class="text-xs sm:text-sm">Connecting...</div>
            </div>
            <div id="settings-content" class="tab-content p-4 sm:p-0 flex flex-col sm:flex-row sm:items-center space-y-4 sm:space-y-0 sm:space-x-2">
                <button id="profile-button" class="bg-white text-blue-600 px-2 sm:px-3 py-1 rounded-lg hover:bg-gray-100 text-sm">My Profile</button>
                <button id="auth-button" class="bg-white text-blue-600 px-2 sm:px-3 py-1 rounded-lg hover:bg-gray-100 text-sm">Sign in with Google</button>
                <button id="theme-toggle" class="bg-gray-200 dark:bg-gray-600 text-blue-600 dark:text-white px-2 sm:px-3 py-1 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 text-sm">
                    Toggle Dark Mode
                </button>
                <div class="settings-item flex flex-col sm:flex-row sm:items-center space-y-2 sm:space-y-0 sm:space-x-2">
                    <label for="bg-color" class="text-xs sm:text-sm text-white sm:text-gray-600 dark:sm:text-gray-300">Background:</label>
                    <input type="color" id="bg-color" class="rounded" value="#f3f4f6">
                </div>
                <div class="settings-item flex flex-col sm:flex-row sm:items-center space-y-2 sm:space-y-0 sm:space-x-2">
                    <label for="nav-bg" class="text-xs sm:text-sm text-white sm:text-gray-600 dark:sm:text-gray-300">Navbar:</label>
                    <input type="color" id="nav-bg" class="rounded" value="#2563eb">
                </div>
                <div class="settings-item flex flex-col sm:flex-row sm:items-center space-y-2 sm:space-y-0 sm:space-x-2">
                    <label for="message-bg" class="text-xs sm:text-sm text-white sm:text-gray-600 dark:sm:text-gray-300">Messages:</label>
                    <input type="color" id="message-bg" class="rounded" value="#ffffff">
                </div>
                <div class="settings-item flex flex-col sm:flex-row sm:items-center space-y-2 sm:space-y-0 sm:space-x-2">
                    <label for="input-bg" class="text-xs sm:text-sm text-white sm:text-gray-600 dark:sm:text-gray-300">Input:</label>
                    <input type="color" id="input-bg" class="rounded" value="#ffffff">
                </div>
                <div class="settings-item flex flex-col sm:flex-row sm:items-center space-y-2 sm:space-y-0 sm:space-x-2">
                    <label for="font-size" class="text-xs sm:text-sm text-white sm:text-gray-600 dark:sm:text-gray-300">Font Size:</label>
                    <select id="font-size" class="border rounded p-1 text-sm">
                        <option value="0.9rem">Small</option>
                        <option value="1rem" selected>Medium</option>
                        <option value="1.1rem">Large</option>
                    </select>
                </div>
            </div>
        </div>
    </nav>

    <!-- Chat Messages Area -->
    <div id="chat-container" class="flex-1 p-2 sm:p-4 overflow-y-auto">
        <div id="messages" class="space-y-2 sm:space-y-4 max-w-3xl mx-auto"></div>
    </div>

    <!-- Input Area -->
    <div id="input-area" class="p-2 sm:p-4 border-t transition-colors duration-300">
        <div class="flex space-x-2 max-w-3xl mx-auto">
            <input
                id="message-input"
                type="text"
                placeholder="Type your message..."
                class="flex-1 border rounded-lg p-2 sm:p-3 text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-blue-500"
                maxlength="200"
            >
            <button
                id="send-button"
                class="bg-blue-600 text-white px-3 sm:px-4 py-2 rounded-lg hover:bg-blue-700 disabled:bg-gray-400 text-sm sm:text-base"
                disabled
            >
                Send
            </button>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profile-modal" class="modal">
        <div class="modal-content">
            <span class="close" id="profile-close">&times;</span>
            <h2 id="profile-title" class="text-lg font-bold">My Profile</h2>
            <form id="profile-form" class="space-y-2">
                <div>
                    <label for="display-name">Display Name:</label>
                    <input id="display-name" type="text" class="border rounded p-1 w-full">
                </div>
                <div>
                    <label for="birthday">Birthday:</label>
                    <input id="birthday" type="date" class="border rounded p-1 w-full">
                </div>
                <div>
                    <label for="gender">Gender:</label>
                    <select id="gender" class="border rounded p-1 w-full">
                        <option value="">Select</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div>
                    <label for="country">Country:</label>
                    <input id="country" type="text" class="border rounded p-1 w-full">
                </div>
                <div>
                    <label>UID:</label>
                    <p id="uid" class="text-sm text-gray-500"></p>
                </div>
                <button type="submit" class="bg-blue-600 text-white px-4 py-1 rounded">Save</button>
            </form>
            <div id="blog-section" class="mt-4">
                <h3 class="text-md font-bold">My Blog Posts</h3>
                <div id="blog-posts" class="space-y-2"></div>
                <div class="mt-2">
                    <input id="blog-title" type="text" placeholder="Title" class="border rounded p-1 w-full mb-1">
                    <textarea id="blog-content" placeholder="Content" class="border rounded p-1 w-full h-20"></textarea>
                    <button id="post-blog" class="bg-blue-600 text-white px-4 py-1 rounded mt-1">Post Blog</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Other User Profile Modal -->
    <div id="other-profile-modal" class="modal">
        <div class="modal-content">
            <span class="close" id="other-profile-close">&times;</span>
            <h2 id="other-profile-title" class="text-lg font-bold">User Profile</h2>
            <div id="other-profile-info" class="space-y-2">
                <p><strong>Display Name:</strong> <span id="other-display-name"></span></p>
                <p><strong>Birthday:</strong> <span id="other-birthday"></span></p>
                <p><strong>Gender:</strong> <span id="other-gender"></span></p>
                <p><strong>Country:</strong> <span id="other-country"></span></p>
                <p><strong>UID:</strong> <span id="other-uid"></span></p>
            </div>
            <div id="other-blog-section" class="mt-4">
                <h3 class="text-md font-bold">Blog Posts</h3>
                <div id="other-blog-posts" class="space-y-2"></div>
            </div>
            <button id="start-private-chat" class="bg-green-600 text-white px-4 py-1 rounded mt-2">Chat Privately</button>
        </div>
    </div>

    <!-- Private Chat Modal -->
    <div id="private-chat-modal" class="modal">
        <div class="modal-content">
            <span class="close" id="private-chat-close">&times;</span>
            <h2 id="private-chat-title" class="text-lg font-bold">Private Chat with <span id="private-chat-user"></span></h2>
            <div id="private-messages" class="space-y-2 h-64 overflow-y-auto"></div>
            <div class="flex space-x-2 mt-2">
                <input id="private-message-input" type="text" placeholder="Type your message..." class="flex-1 border rounded p-2">
                <button id="private-send-button" class="bg-blue-600 text-white px-4 py-2 rounded">Send</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration (Replace with your own)
        const firebaseConfig = {
            apiKey: "AIzaSyA4ace9iq9tr66MbJiI81Cuq8ruu1SnfYg",
            authDomain: "onichat-35008.firebaseapp.com",
            databaseURL: "https://onichat-35008-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "onichat-35008",
            storageBucket: "onichat-35008.appspot.com",
            messagingSenderId: "712555244409",
            appId: "1:712555244409:web:6c1a4ac156be18593ddda8"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        const messagesRef = database.ref('messages');

        // Google Auth Provider
        const provider = new firebase.auth.GoogleAuthProvider();

        // DOM elements
        const htmlRoot = document.getElementById('html-root');
        const menuButton = document.getElementById('menu-button');
        const menu = document.getElementById('menu');
        const tabStatus = document.getElementById('tab-status');
        const tabSettings = document.getElementById('tab-settings');
        const statusContent = document.getElementById('status-content');
        const settingsContent = document.getElementById('settings-content');
        const connectionStatus = document.getElementById('connection-status');
        const userStatus = document.getElementById('user-status');
        const userName = document.getElementById('user-name');
        const authButton = document.getElementById('auth-button');
        const themeToggle = document.getElementById('theme-toggle');
        const inputArea = document.getElementById('input-area');
        const messagesDiv = document.getElementById('messages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const bgColorInput = document.getElementById('bg-color');
        const navBgInput = document.getElementById('nav-bg');
        const messageBgInput = document.getElementById('message-bg');
        const inputBgInput = document.getElementById('input-bg');
        const fontSizeSelect = document.getElementById('font-size');
        const profileButton = document.getElementById('profile-button');
        const profileModal = document.getElementById('profile-modal');
        const profileClose = document.getElementById('profile-close');
        const profileForm = document.getElementById('profile-form');
        const displayNameInput = document.getElementById('display-name');
        const birthdayInput = document.getElementById('birthday');
        const genderSelect = document.getElementById('gender');
        const countryInput = document.getElementById('country');
        const uidP = document.getElementById('uid');
        const blogTitleInput = document.getElementById('blog-title');
        const blogContentTextarea = document.getElementById('blog-content');
        const postBlogButton = document.getElementById('post-blog');
        const blogPostsDiv = document.getElementById('blog-posts');
        const otherProfileModal = document.getElementById('other-profile-modal');
        const otherProfileClose = document.getElementById('other-profile-close');
        const otherDisplayName = document.getElementById('other-display-name');
        const otherBirthday = document.getElementById('other-birthday');
        const otherGender = document.getElementById('other-gender');
        const otherCountry = document.getElementById('other-country');
        const otherUid = document.getElementById('other-uid');
        const otherBlogPostsDiv = document.getElementById('other-blog-posts');
        const startPrivateChatButton = document.getElementById('start-private-chat');
        const privateChatModal = document.getElementById('private-chat-modal');
        const privateChatClose = document.getElementById('private-chat-close');
        const privateChatUser = document.getElementById('private-chat-user');
        const privateMessagesDiv = document.getElementById('private-messages');
        const privateMessageInput = document.getElementById('private-message-input');
        const privateSendButton = document.getElementById('private-send-button');

        // Load saved customization
        const savedTheme = localStorage.getItem('theme') || 'light';
        htmlRoot.classList.remove('light', 'dark');
        htmlRoot.classList.add(savedTheme);
        themeToggle.textContent = savedTheme === 'light' ? 'Dark Mode' : 'Light Mode';

        const savedCustomizations = JSON.parse(localStorage.getItem('customizations')) || {};
        bgColorInput.value = savedCustomizations.bgColor || (savedTheme === 'light' ? '#f3f4f6' : '#1f2937');
        navBgInput.value = savedCustomizations.navBg || (savedTheme === 'light' ? '#2563eb' : '#1e40af');
        messageBgInput.value = savedCustomizations.messageBg || (savedTheme === 'light' ? '#ffffff' : '#374151');
        inputBgInput.value = savedCustomizations.inputBg || (savedTheme === 'light' ? '#ffffff' : '#374151');
        fontSizeSelect.value = savedCustomizations.fontSize || '1rem';

        // Apply saved customizations
        document.documentElement.style.setProperty('--bg-color', bgColorInput.value);
        document.documentElement.style.setProperty('--nav-bg', navBgInput.value);
        document.documentElement.style.setProperty('--message-bg', messageBgInput.value);
        document.documentElement.style.setProperty('--input-bg', inputBgInput.value);
        document.documentElement.style.setProperty('--message-font-size', fontSizeSelect.value);

        // Save and apply color customizations
        function saveCustomizations() {
            const customizations = {
                bgColor: bgColorInput.value,
                navBg: navBgInput.value,
                messageBg: messageBgInput.value,
                inputBg: inputBgInput.value,
                fontSize: fontSizeSelect.value
            };
            localStorage.setItem('customizations', JSON.stringify(customizations));
            document.documentElement.style.setProperty('--bg-color', bgColorInput.value);
            document.documentElement.style.setProperty('--nav-bg', navBgInput.value);
            document.documentElement.style.setProperty('--message-bg', messageBgInput.value);
            document.documentElement.style.setProperty('--input-bg', inputBgInput.value);
            document.documentElement.style.setProperty('--message-font-size', fontSizeSelect.value);
        }

        // Event listeners for customization
        bgColorInput.addEventListener('input', saveCustomizations);
        navBgInput.addEventListener('input', saveCustomizations);
        messageBgInput.addEventListener('input', saveCustomizations);
        inputBgInput.addEventListener('input', saveCustomizations);
        fontSizeSelect.addEventListener('change', saveCustomizations);

        // Dark mode toggle
        themeToggle.addEventListener('click', () => {
            const newTheme = htmlRoot.classList.contains('light') ? 'dark' : 'light';
            htmlRoot.classList.remove('light', 'dark');
            htmlRoot.classList.add(newTheme);
            themeToggle.textContent = newTheme === 'light' ? 'Dark Mode' : 'Light Mode';
            localStorage.setItem('theme', newTheme);
            // Reset colors to theme defaults if switching
            bgColorInput.value = newTheme === 'light' ? '#f3f4f6' : '#1f2937';
            navBgInput.value = newTheme === 'light' ? '#2563eb' : '#1e40af';
            messageBgInput.value = newTheme === 'light' ? '#ffffff' : '#374151';
            inputBgInput.value = newTheme === 'light' ? '#ffffff' : '#374151';
            saveCustomizations();
            menu.classList.add('hidden'); // Close menu after action
        });

        // Menu toggle for mobile
        menuButton.addEventListener('click', () => {
            menu.classList.toggle('hidden');
        });

        // Close menu when clicking outside (mobile only)
        document.addEventListener('click', (e) => {
            if (!menu.contains(e.target) && !menuButton.contains(e.target) && window.innerWidth < 640) {
                menu.classList.add('hidden');
            }
        });

        // Tab switching
        tabStatus.addEventListener('click', () => {
            tabStatus.classList.add('active');
            tabSettings.classList.remove('active');
            statusContent.classList.add('active');
            settingsContent.classList.remove('active');
        });

        tabSettings.addEventListener('click', () => {
            tabSettings.classList.add('active');
            tabStatus.classList.remove('active');
            settingsContent.classList.add('active');
            statusContent.classList.remove('active');
        });

        // Monitor Firebase connection status
        database.ref('.info/connected').on('value', (snapshot) => {
            if (snapshot.val()) {
                connectionStatus.textContent = 'Connected';
                connectionStatus.classList.remove('text-red-300');
                connectionStatus.classList.add('text-green-300');
            } else {
                connectionStatus.textContent = 'Disconnected';
                connectionStatus.classList.remove('text-green-300');
                connectionStatus.classList.add('text-red-300');
            }
        });

        // Handle authentication state
        auth.onAuthStateChanged((user) => {
            if (user) {
                // User is signed in
                userStatus.classList.remove('hidden');
                userName.textContent = user.displayName || 'Anonymous';
                authButton.textContent = 'Sign Out';
                inputArea.classList.remove('hidden');
                sendButton.disabled = false;
                profileButton.disabled = false;
                loadProfile(user.uid);
            } else {
                // User is signed out
                userStatus.classList.add('hidden');
                authButton.textContent = 'Sign in with Google';
                inputArea.classList.add('hidden');
                sendButton.disabled = true;
                profileButton.disabled = true;
            }
            updateSendButton();
        });

        // Sign in/out button handler
        authButton.addEventListener('click', () => {
            if (auth.currentUser) {
                auth.signOut().catch((error) => {
                    console.error('Sign out error:', error);
                    alert('Failed to sign out.');
                });
            } else {
                auth.signInWithPopup(provider).catch((error) => {
                    console.error('Sign in error:', error);
                    alert('Failed to sign in: ' + error.message);
                });
            }
            menu.classList.add('hidden'); // Close menu after action
        });

        // Handle sending messages (only if authenticated)
        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !sendButton.disabled) {
                sendMessage();
            }
        });

        function sendMessage() {
            const user = auth.currentUser;
            const message = messageInput.value.trim();

            if (!user || !message) {
                alert('Please sign in and enter a message.');
                return;
            }

            const timestamp = Date.now();
            messagesRef.push({
                uid: user.uid,
                name: user.displayName || 'Anonymous',
                message: message,
                timestamp: timestamp
            }).then(() => {
                messageInput.value = '';
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }).catch((error) => {
                console.error('Error sending message:', error);
                alert('Failed to send message. Please try again.');
            });
        }

        // Listen for new messages
        messagesRef.orderByChild('timestamp').limitToLast(50).on('child_added', (snapshot) => {
            const data = snapshot.val();
            if (data && data.name && data.message) {
                const messageElement = document.createElement('div');
                messageElement.classList.add('message', 'p-3', 'rounded-lg', 'shadow', 'max-w-full', 'sm:max-w-2xl');
                messageElement.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <span class="font-bold text-blue-600 dark:text-blue-400 cursor-pointer user-name" data-uid="${sanitizeHTML(data.uid)}">${sanitizeHTML(data.name)}</span>:
                            <span class="message-text">${sanitizeHTML(data.message)}</span>
                        </div>
                        <span class="text-xs text-gray-500 dark:text-gray-400">${new Date(data.timestamp).toLocaleTimeString()}</span>
                    </div>
                `;
                messagesDiv.appendChild(messageElement);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }
        });

        // Click on user name to view profile
        messagesDiv.addEventListener('click', (e) => {
            if (e.target.classList.contains('user-name')) {
                const uid = e.target.dataset.uid;
                loadOtherProfile(uid);
                otherProfileModal.style.display = 'block';
            }
        });

        // Basic HTML sanitization to prevent XSS
        function sanitizeHTML(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        // Enable/disable send button based on input
        function updateSendButton() {
            const message = messageInput.value.trim();
            sendButton.disabled = !message || !auth.currentUser || connectionStatus.textContent !== 'Connected';
        }

        messageInput.addEventListener('input', updateSendButton);

        // Initialize button state
        updateSendButton();

        // Profile modal handlers
        profileButton.addEventListener('click', () => {
            if (auth.currentUser) {
                profileModal.style.display = 'block';
                menu.classList.add('hidden');
            } else {
                alert('Please sign in to access profile.');
            }
        });

        profileClose.addEventListener('click', () => {
            profileModal.style.display = 'none';
        });

        window.addEventListener('click', (e) => {
            if (e.target === profileModal) {
                profileModal.style.display = 'none';
            }
        });

        // Load profile data
        function loadProfile(uid) {
            const userRef = database.ref(`users/${uid}`);
            userRef.once('value').then((snapshot) => {
                const data = snapshot.val() || {};
                displayNameInput.value = data.displayName || '';
                birthdayInput.value = data.birthday || '';
                genderSelect.value = data.gender || '';
                countryInput.value = data.country || '';
                uidP.textContent = uid;
                loadBlogPosts(uid, blogPostsDiv, true); // true for own posts
            });
        }

        // Save profile data
        profileForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (user) {
                const userRef = database.ref(`users/${user.uid}`);
                userRef.update({
                    displayName: displayNameInput.value,
                    birthday: birthdayInput.value,
                    gender: genderSelect.value,
                    country: countryInput.value
                }).then(() => {
                    alert('Profile saved!');
                }).catch((error) => {
                    console.error('Error saving profile:', error);
                    alert('Failed to save profile.');
                });
            }
        });

        // Post blog
        postBlogButton.addEventListener('click', () => {
            const user = auth.currentUser;
            const title = blogTitleInput.value.trim();
            const content = blogContentTextarea.value.trim();
            if (user && title && content) {
                const postsRef = database.ref(`users/${user.uid}/posts`);
                const timestamp = Date.now();
                postsRef.push({
                    title: title,
                    content: content,
                    timestamp: timestamp
                }).then(() => {
                    blogTitleInput.value = '';
                    blogContentTextarea.value = '';
                    loadBlogPosts(user.uid, blogPostsDiv, true);
                }).catch((error) => {
                    console.error('Error posting blog:', error);
                    alert('Failed to post blog.');
                });
            } else {
                alert('Please enter title and content.');
            }
        });

        // Load blog posts
        function loadBlogPosts(uid, container, isOwn) {
            container.innerHTML = '';
            const postsRef = database.ref(`users/${uid}/posts`);
            postsRef.orderByChild('timestamp').on('value', (snapshot) => {
                container.innerHTML = '';
                snapshot.forEach((childSnapshot) => {
                    const post = childSnapshot.val();
                    const postElement = document.createElement('div');
                    postElement.classList.add('border', 'p-2', 'rounded');
                    postElement.innerHTML = `
                        <h4 class="font-bold">${sanitizeHTML(post.title)}</h4>
                        <p>${sanitizeHTML(post.content)}</p>
                        <span class="text-xs text-gray-500">${new Date(post.timestamp).toLocaleString()}</span>
                    `;
                    if (isOwn) {
                        const deleteButton = document.createElement('button');
                        deleteButton.textContent = 'Delete';
                        deleteButton.classList.add('bg-red-600', 'text-white', 'px-2', 'py-1', 'rounded', 'text-xs', 'mt-1');
                        deleteButton.addEventListener('click', () => {
                            postsRef.child(childSnapshot.key).remove().then(() => {
                                loadBlogPosts(uid, container, isOwn);
                            });
                        });
                        postElement.appendChild(deleteButton);
                    }
                    container.appendChild(postElement);
                });
            });
        }

        // Load other user's profile
        function loadOtherProfile(uid) {
            const userRef = database.ref(`users/${uid}`);
            userRef.once('value').then((snapshot) => {
                const data = snapshot.val() || {};
                otherDisplayName.textContent = data.displayName || 'Anonymous';
                otherBirthday.textContent = data.birthday || 'Not set';
                otherGender.textContent = data.gender || 'Not set';
                otherCountry.textContent = data.country || 'Not set';
                otherUid.textContent = uid;
                loadBlogPosts(uid, otherBlogPostsDiv, false); // false for other user's posts
                startPrivateChatButton.dataset.uid = uid;
                startPrivateChatButton.dataset.name = data.displayName || 'Anonymous';
            });
        }

        // Other profile modal handlers
        otherProfileClose.addEventListener('click', () => {
            otherProfileModal.style.display = 'none';
        });

        window.addEventListener('click', (e) => {
            if (e.target === otherProfileModal) {
                otherProfileModal.style.display = 'none';
            }
        });

        // Start private chat
        startPrivateChatButton.addEventListener('click', () => {
            const otherUid = startPrivateChatButton.dataset.uid;
            const otherName = startPrivateChatButton.dataset.name;
            if (auth.currentUser) {
                const currentUid = auth.currentUser.uid;
                const chatId = [currentUid, otherUid].sort().join('_');
                privateChatUser.textContent = otherName;
                privateChatModal.style.display = 'block';
                loadPrivateMessages(chatId);
                privateSendButton.dataset.chatId = chatId;
                otherProfileModal.style.display = 'none';
            } else {
                alert('Please sign in to chat privately.');
            }
        });

        // Private chat modal handlers
        privateChatClose.addEventListener('click', () => {
            privateChatModal.style.display = 'none';
        });

        window.addEventListener('click', (e) => {
            if (e.target === privateChatModal) {
                privateChatModal.style.display = 'none';
            }
        });

        // Load private messages
        function loadPrivateMessages(chatId) {
            privateMessagesDiv.innerHTML = '';
            const privateMessagesRef = database.ref(`chats/${chatId}/messages`);
            privateMessagesRef.orderByChild('timestamp').on('child_added', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    const messageElement = document.createElement('div');
                    messageElement.classList.add('p-2', 'border-b');
                    messageElement.innerHTML = `
                        <span class="font-bold">${sanitizeHTML(data.name)}:</span>
                        ${sanitizeHTML(data.message)}
                        <span class="text-xs text-gray-500">${new Date(data.timestamp).toLocaleTimeString()}</span>
                    `;
                    privateMessagesDiv.appendChild(messageElement);
                    privateMessagesDiv.scrollTop = privateMessagesDiv.scrollHeight;
                }
            });
        }

        // Send private message
        privateSendButton.addEventListener('click', sendPrivateMessage);
        privateMessageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendPrivateMessage();
            }
        });

        function sendPrivateMessage() {
            const chatId = privateSendButton.dataset.chatId;
            const user = auth.currentUser;
            const message = privateMessageInput.value.trim();

            if (user && message) {
                const privateMessagesRef = database.ref(`chats/${chatId}/messages`);
                const timestamp = Date.now();
                privateMessagesRef.push({
                    uid: user.uid,
                    name: user.displayName || 'Anonymous',
                    message: message,
                    timestamp: timestamp
                }).then(() => {
                    privateMessageInput.value = '';
                    privateMessagesDiv.scrollTop = privateMessagesDiv.scrollHeight;
                }).catch((error) => {
                    console.error('Error sending private message:', error);
                    alert('Failed to send private message.');
                });
            } else {
                alert('Please enter a message.');
            }
        }
    </script>
</body>
</html>